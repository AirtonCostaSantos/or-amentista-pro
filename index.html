
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orçamentista Pro - Drywall & Interiores</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&display=swap');
        
        :root {
            --primary: #f59e0b;
            --primary-dark: #d97706;
            --slate-900: #0f172a;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f1f5f9;
            color: #1e293b;
            direction: ltr !important;
        }
        
        .tab-active { background-color: var(--primary); color: white; }
        .tab-inactive { background-color: #f8fafc; color: #94a3b8; border-bottom: 1px solid #e2e8f0; }
        
        @media print {
            .print-hidden { display: none !important; }
            body { background: white !important; }
            .shadow-xl { box-shadow: none !important; border: 1px solid #e2e8f0 !important; }
            #sidebar { display: none !important; }
            #result-container { width: 100% !important; margin: 0 !important; }
        }

        input, select { 
            @apply transition-all duration-200 outline-none bg-slate-50 border-2 border-slate-100 rounded-xl px-4 py-3 text-sm font-semibold w-full text-slate-700;
            text-align: left !important;
        }
        input:focus { @apply ring-2 ring-amber-500 border-amber-500 bg-white; }
        
        .custom-scrollbar::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        .form-label {
            @apply block text-[10px] font-black text-slate-500 uppercase mb-1.5 tracking-widest;
        }

        /* Estilo para simular papel no preview */
        .document-paper {
            background: white;
            min-height: 29.7cm;
            padding: 2cm;
        }
    </style>
    <script type="importmap">
    {
      "imports": {
        "@google/genai": "https://esm.sh/@google/genai@^1.37.0"
      }
    }
    </script>
</head>
<body class="min-h-screen pb-10">

    <header class="bg-slate-900 text-white py-6 px-4 shadow-2xl mb-8 print:hidden border-b-4 border-amber-500">
        <div class="max-w-7xl mx-auto flex flex-col md:flex-row items-center justify-between gap-6">
            <div class="flex items-center gap-4">
                <div class="bg-amber-500 p-3 rounded-2xl shadow-lg">
                    <i class="fas fa-calculator text-2xl text-slate-900"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-black uppercase italic tracking-tighter leading-none">Orçamentista Pro</h1>
                    <p class="text-amber-500 font-bold text-[10px] uppercase tracking-widest mt-1">Gestão Técnica de Drywall & Interiores</p>
                </div>
            </div>
            
            <div class="flex gap-3">
                <button onclick="window.getAiAnalysis()" id="ai-btn" class="px-5 py-2.5 bg-slate-800 hover:bg-slate-700 rounded-xl font-black flex items-center gap-2 text-[11px] uppercase tracking-widest transition-all">
                    <i class="fas fa-magic"></i> Analisar com IA
                </button>
                <button onclick="window.print()" class="px-5 py-2.5 bg-amber-500 hover:bg-amber-600 text-slate-900 rounded-xl font-black flex items-center gap-2 text-[11px] uppercase tracking-widest shadow-lg">
                    <i class="fas fa-print"></i> PDF / Imprimir
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 grid grid-cols-1 lg:grid-cols-12 gap-8">
        
        <!-- SIDEBAR DE INPUTS -->
        <section id="sidebar" class="lg:col-span-4 space-y-6 print:hidden">
            <div class="bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden sticky top-8">
                <div class="flex border-b overflow-x-auto custom-scrollbar" id="tab-headers">
                    <button onclick="window.switchTab('project')" id="tab-btn-project" class="flex-1 py-4 px-2 text-[10px] font-black uppercase tab-active">Projeto</button>
                    <button onclick="window.switchTab('customer')" id="tab-btn-customer" class="flex-1 py-4 px-2 text-[10px] font-black uppercase tab-inactive">Cliente</button>
                    <button onclick="window.switchTab('company')" id="tab-btn-company" class="flex-1 py-4 px-2 text-[10px] font-black uppercase tab-inactive">Empresa</button>
                    <button onclick="window.switchTab('registry')" id="tab-btn-registry" class="flex-1 py-4 px-2 text-[10px] font-black uppercase tab-inactive">Preços</button>
                </div>

                <div class="p-6" id="form-container">
                    <!-- Formulário será injetado aqui -->
                </div>

                <div class="bg-slate-900 p-6 border-t-4 border-amber-500">
                    <h4 class="text-amber-500 font-black text-[11px] mb-2 uppercase tracking-widest">Normas Técnicas</h4>
                    <p class="text-[10px] text-slate-400 leading-relaxed font-medium">
                        Cálculos baseados na NBR 14715 (Placas) e NBR 15758 (Sistemas Gesso). Margem de perda padrão de 10% inclusa.
                    </p>
                </div>
            </div>
        </section>

        <!-- PREVIEW DO DOCUMENTO -->
        <section id="result-container" class="lg:col-span-8">
            <div id="document-render" class="document-paper shadow-2xl rounded-3xl border border-slate-200">
                <!-- Conteúdo do orçamento injetado aqui -->
            </div>
        </section>
    </main>

    <script type="module">
        import { GoogleGenAI } from "@google/genai";

        // CONFIGURAÇÃO INICIAL E ESTADO
        const storageKey = 'orc_pro_v10';
        const defaultRegistry = {
            materials: [
                { name: 'Chapa Drywall ST 1.20x2.40', price: 48.50, unit: 'un' },
                { name: 'Chapa Drywall RU (Verde)', price: 68.00, unit: 'un' },
                { name: 'Perfil F-530 (3m)', price: 18.90, unit: 'un' },
                { name: 'Massa Drywall 20kg', price: 89.00, unit: 'un' },
                { name: 'Parafuso TN25 (Cento)', price: 14.50, unit: 'un' }
            ],
            services: [
                { name: 'Mão de Obra Drywall', price: 40.00, unit: 'm²' },
                { name: 'Pintura (Mão de Obra)', price: 22.00, unit: 'm²' }
            ]
        };

        let state = JSON.parse(localStorage.getItem(storageKey)) || {
            activeTab: 'project',
            mode: 'Forro Liso',
            length: 5,
            width: 4,
            height: 2.7,
            isDouble: false,
            boardType: 'ST (Branca)',
            customer: { name: '', email: '', document: '', address: '', contact: '', city: '' },
            company: { name: 'Sua Empresa Drywall', email: 'contato@empresa.com', document: '00.000.000/0001-00', address: 'Rua das Obras, 123', contact: '(11) 9999-8888', city: 'São Paulo - SP' },
            registry: defaultRegistry,
            aiSummary: '',
            loadingAi: false
        };

        function save() {
            localStorage.setItem(storageKey, JSON.stringify(state));
        }

        // FUNÇÕES DE CÁLCULO
        function calculate() {
            const area = state.length * state.width;
            const perimeter = (state.length * 2) + (state.width * 2);
            const margin = 1.10;
            
            const results = {
                area: area,
                items: [
                    { name: `Placa Drywall ${state.boardType}`, qty: Math.ceil((area / 2.88) * margin * (state.isDouble ? 2 : 1)), unit: 'un' },
                    { name: 'Perfil F-530 (3m)', qty: Math.ceil((area * 1.5) / 3), unit: 'un' },
                    { name: 'Cantoneira L 25x30', qty: Math.ceil(perimeter / 3), unit: 'un' },
                    { name: 'Massa Drywall 20kg', qty: Math.ceil(area / 18), unit: 'un' },
                    { name: 'Fita Telada (Rolos)', qty: Math.ceil(area / 30), unit: 'un' }
                ],
                services: [
                    { name: `Instalação de ${state.mode}`, qty: area, unit: 'm²' }
                ],
                total: 0
            };

            // Atribuir preços do catálogo
            [...results.items, ...results.services].forEach(item => {
                const reg = [...state.registry.materials, ...state.registry.services].find(r => item.name.toLowerCase().includes(r.name.toLowerCase()) || r.name.toLowerCase().includes(item.name.toLowerCase()));
                item.price = reg ? reg.price : 0;
                item.subtotal = item.qty * item.price;
                results.total += item.subtotal;
            });

            return results;
        }

        // RENDERIZAÇÃO
        window.switchTab = (tab) => {
            state.activeTab = tab;
            renderAll();
        };

        window.updateInput = (obj, key, val) => {
            if (obj) {
                state[obj][key] = val;
            } else {
                state[key] = val;
            }
            save();
            renderDocument(); // Atualiza o preview mas NÃO o formulário para manter o cursor
        };

        window.getAiAnalysis = async () => {
            if (state.loadingAi) return;
            state.loadingAi = true;
            renderAll();
            
            const calc = calculate();
            try {
                const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });
                const prompt = `Analise este orçamento de drywall. Área: ${calc.area}m2. Custo: R$ ${calc.total}. Escreva um memorial técnico curto (3 parágrafos) em português citando normas ABNT.`;
                const response = await ai.models.generateContent({ model: 'gemini-3-flash-preview', contents: prompt });
                state.aiSummary = response.text;
            } catch (e) {
                state.aiSummary = "Memorial Técnico: Sistema de forro executado conforme NBR 14715, garantindo estanqueidade e isolamento termoacústico.";
            } finally {
                state.loadingAi = false;
                renderAll();
            }
        };

        function renderForm() {
            const container = document.getElementById('form-container');
            const tab = state.activeTab;
            
            // Renderiza o cabeçalho das abas
            document.querySelectorAll('#tab-headers button').forEach(b => {
                const id = b.id.replace('tab-btn-', '');
                b.className = `flex-1 py-4 px-2 text-[10px] font-black uppercase transition-all ${state.activeTab === id ? 'tab-active' : 'tab-inactive'}`;
            });

            if (tab === 'project') {
                container.innerHTML = `
                    <div class="space-y-4">
                        <label class="form-label">Tipo de Projeto</label>
                        <select onchange="window.updateInput(null, 'mode', this.value); window.renderForm();">
                            <option ${state.mode === 'Forro Liso' ? 'selected' : ''}>Forro Liso</option>
                            <option ${state.mode === 'Forro Tabicado' ? 'selected' : ''}>Forro Tabicado</option>
                            <option ${state.mode === 'Parede Drywall' ? 'selected' : ''}>Parede Drywall</option>
                        </select>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="form-label">Comprimento (m)</label>
                                <input type="number" step="0.1" value="${state.length}" oninput="window.updateInput(null, 'length', parseFloat(this.value))">
                            </div>
                            <div>
                                <label class="form-label">Largura (m)</label>
                                <input type="number" step="0.1" value="${state.width}" oninput="window.updateInput(null, 'width', parseFloat(this.value))">
                            </div>
                        </div>

                        <div>
                            <label class="form-label">Tipo de Chapa</label>
                            <select onchange="window.updateInput(null, 'boardType', this.value)">
                                <option ${state.boardType === 'ST (Branca)' ? 'selected' : ''}>ST (Branca)</option>
                                <option ${state.boardType === 'RU (Verde)' ? 'selected' : ''}>RU (Verde)</option>
                                <option ${state.boardType === 'RF (Rosa)' ? 'selected' : ''}>RF (Rosa)</option>
                            </select>
                        </div>

                        <div class="flex items-center gap-3 p-4 bg-slate-50 rounded-xl border border-slate-100">
                            <input type="checkbox" ${state.isDouble ? 'checked' : ''} onchange="window.updateInput(null, 'isDouble', this.checked)" class="w-5 h-5 accent-amber-500">
                            <label class="text-[10px] font-black uppercase text-slate-600">Chapa Dupla / Camada Dupla</label>
                        </div>
                    </div>
                `;
            } else if (tab === 'customer' || tab === 'company') {
                const target = state[tab];
                container.innerHTML = `
                    <div class="space-y-4">
                        <h3 class="text-[11px] font-black uppercase text-amber-600 mb-2 italic">Dados de Cadastro</h3>
                        <div>
                            <label class="form-label">Nome / Razão Social</label>
                            <input type="text" value="${target.name}" oninput="window.updateInput('${tab}', 'name', this.value)" placeholder="Nome Completo">
                        </div>
                        <div>
                            <label class="form-label">CPF / CNPJ</label>
                            <input type="text" value="${target.document}" oninput="window.updateInput('${tab}', 'document', this.value)" placeholder="00.000.000/0000-00">
                        </div>
                        <div>
                            <label class="form-label">E-mail para Orçamento</label>
                            <input type="text" value="${target.email}" oninput="window.updateInput('${tab}', 'email', this.value)" placeholder="email@provedor.com">
                        </div>
                        <div>
                            <label class="form-label">Telefone / WhatsApp</label>
                            <input type="text" value="${target.contact}" oninput="window.updateInput('${tab}', 'contact', this.value)" placeholder="(00) 0 0000-0000">
                        </div>
                        <div>
                            <label class="form-label">Cidade - UF</label>
                            <input type="text" value="${target.city}" oninput="window.updateInput('${tab}', 'city', this.value)" placeholder="Cidade - UF">
                        </div>
                        <div>
                            <label class="form-label">Endereço</label>
                            <input type="text" value="${target.address}" oninput="window.updateInput('${tab}', 'address', this.value)" placeholder="Logradouro, Bairro">
                        </div>
                        <button onclick="window.clearContact('${tab}')" class="w-full py-2 text-[9px] font-black text-slate-400 uppercase tracking-widest hover:text-red-500 transition-colors">Limpar Campos</button>
                    </div>
                `;
            } else if (tab === 'registry') {
                container.innerHTML = `
                    <div class="space-y-4">
                        <h3 class="text-[11px] font-black uppercase text-amber-600 mb-2 italic">Tabela de Preços</h3>
                        <div class="max-h-96 overflow-y-auto custom-scrollbar space-y-2 pr-2">
                            ${[...state.registry.materials, ...state.registry.services].map((item, idx) => `
                                <div class="p-3 bg-slate-50 border border-slate-100 rounded-xl">
                                    <p class="text-[10px] font-black text-slate-700 truncate">${item.name}</p>
                                    <div class="flex items-center gap-2 mt-2">
                                        <span class="text-[10px] font-bold text-slate-400">R$</span>
                                        <input type="number" step="0.01" value="${item.price}" class="py-1 px-2 !rounded-lg !text-xs" 
                                            oninput="window.updateRegistryPrice(${idx}, parseFloat(this.value))">
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
        }

        window.updateRegistryPrice = (idx, val) => {
            const all = [...state.registry.materials, ...state.registry.services];
            all[idx].price = isNaN(val) ? 0 : val;
            save();
            renderDocument();
        };

        function renderDocument() {
            const data = calculate();
            const el = document.getElementById('document-render');
            
            el.innerHTML = `
                <div class="flex justify-between items-start border-b-8 border-slate-900 pb-8 mb-8">
                    <div>
                        <h2 class="text-3xl font-black text-slate-900 italic tracking-tighter uppercase leading-none">Proposta Comercial</h2>
                        <p class="text-amber-500 font-black text-xs uppercase tracking-[0.3em] mt-2">Orçamento Técnico #${Math.floor(Math.random()*10000)}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-[11px] font-black text-slate-400 uppercase">Data de Emissão</p>
                        <p class="text-sm font-black text-slate-900">${new Date().toLocaleDateString('pt-BR')}</p>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-12 mb-12">
                    <div>
                        <h4 class="text-amber-500 font-black text-[10px] uppercase tracking-widest mb-4 italic">PRESTADOR</h4>
                        <p class="text-xl font-black text-slate-900">${state.company.name || '---'}</p>
                        <div class="text-[11px] text-slate-500 mt-4 space-y-1">
                            <p><i class="fas fa-id-card w-5 text-amber-500"></i> ${state.company.document || '---'}</p>
                            <p><i class="fas fa-at w-5 text-amber-500"></i> ${state.company.email || '---'}</p>
                            <p><i class="fas fa-phone w-5 text-amber-500"></i> ${state.company.contact || '---'}</p>
                            <p><i class="fas fa-map-marker-alt w-5 text-amber-500"></i> ${state.company.city || '---'}</p>
                        </div>
                    </div>
                    <div class="bg-slate-50 p-6 rounded-3xl border-2 border-slate-100">
                        <h4 class="text-amber-500 font-black text-[10px] uppercase tracking-widest mb-4 italic">CLIENTE</h4>
                        <p class="text-lg font-black text-slate-800">${state.customer.name || '---'}</p>
                        <div class="text-[11px] text-slate-500 mt-4 space-y-1">
                            <p><i class="fas fa-at w-5 text-amber-500"></i> ${state.customer.email || '---'}</p>
                            <p><i class="fas fa-phone w-5 text-amber-500"></i> ${state.customer.contact || '---'}</p>
                            <p><i class="fas fa-map-marker-alt w-5 text-amber-500"></i> ${state.customer.address || '---'}</p>
                        </div>
                    </div>
                </div>

                <div class="mb-10">
                    <h3 class="text-sm font-black text-slate-900 uppercase mb-6 flex items-center gap-3">
                        <span class="w-8 h-1 bg-amber-500"></span> Composição de Materiais e Serviços
                    </h3>
                    <div class="border-2 border-slate-100 rounded-2xl overflow-hidden">
                        <table class="w-full text-xs">
                            <thead class="bg-slate-900 text-white">
                                <tr>
                                    <th class="px-6 py-4 text-left font-black uppercase tracking-widest">Descrição Técnica</th>
                                    <th class="px-6 py-4 text-right font-black uppercase tracking-widest">Qtd</th>
                                    <th class="px-6 py-4 text-right font-black uppercase tracking-widest">Valor Unit.</th>
                                    <th class="px-6 py-4 text-right font-black uppercase tracking-widest">Subtotal</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100">
                                ${[...data.items, ...data.services].map(i => `
                                    <tr>
                                        <td class="px-6 py-4 font-bold text-slate-700">${i.name}</td>
                                        <td class="px-6 py-4 text-right font-bold text-slate-500">${i.qty} ${i.unit}</td>
                                        <td class="px-6 py-4 text-right text-slate-400">R$ ${i.price.toFixed(2)}</td>
                                        <td class="px-6 py-4 text-right font-black text-slate-900">R$ ${i.subtotal.toFixed(2)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="bg-slate-900 text-white p-10 rounded-[40px] flex justify-between items-center shadow-2xl">
                    <div>
                        <h4 class="text-amber-500 font-black text-sm uppercase tracking-[0.2em] mb-2 italic">Investimento Total</h4>
                        <p class="text-[10px] text-slate-400 font-medium uppercase max-w-xs leading-relaxed">Válido por 15 dias. Inclui todos os insumos e mão de obra conforme levantamento.</p>
                    </div>
                    <div class="text-5xl font-black text-amber-500 tracking-tighter italic">R$ ${data.total.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</div>
                </div>

                ${state.aiSummary ? `
                    <div class="mt-12 p-8 bg-amber-50 border-l-[10px] border-amber-500 rounded-r-[30px]">
                        <h4 class="text-amber-800 font-black text-[11px] uppercase tracking-widest mb-4 flex items-center gap-2">
                            <i class="fas fa-file-contract"></i> Memorial Descritivo de Obra
                        </h4>
                        <div class="text-slate-700 text-xs leading-relaxed italic whitespace-pre-wrap">${state.aiSummary}</div>
                    </div>
                ` : ''}

                <div class="mt-24 grid grid-cols-2 gap-20">
                    <div class="text-center border-t-2 border-slate-200 pt-4">
                        <p class="text-[11px] font-black text-slate-900 uppercase">${state.company.name}</p>
                        <p class="text-[9px] text-slate-400 font-bold uppercase tracking-widest mt-1">Responsável Técnico</p>
                    </div>
                    <div class="text-center border-t-2 border-slate-200 pt-4">
                        <p class="text-[11px] font-black text-slate-900 uppercase">${state.customer.name || 'Contratante'}</p>
                        <p class="text-[9px] text-slate-400 font-bold uppercase tracking-widest mt-1">Aceite do Orçamento</p>
                    </div>
                </div>
            `;
        }

        function renderAll() {
            renderHeader();
            renderForm();
            renderDocument();
        }

        window.onload = () => renderAll();
    </script>
</body>
</html>
